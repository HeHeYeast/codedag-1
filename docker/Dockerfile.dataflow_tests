# CodeDAG数据流图解析测试专用Docker镜像
FROM nvidia/cuda:11.4.3-cudnn8-runtime-ubuntu20.04

# 环境变量设置
ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1
ENV CUDA_VISIBLE_DEVICES=0,1,2,3

# 基础系统包安装
RUN apt-get update && apt-get install -y \
    python3.9 \
    python3.9-dev \
    python3-pip \
    git \
    wget \
    vim \
    htop \
    tree \
    jq \
    && rm -rf /var/lib/apt/lists/*

# 创建python链接
RUN ln -s /usr/bin/python3.9 /usr/bin/python

# 升级pip
RUN python -m pip install --upgrade pip

# 安装PyTorch (CUDA 11.3以兼容驱动)
RUN pip install --no-cache-dir \
    torch==1.12.1+cu113 \
    torchvision==0.13.1+cu113 \
    torchaudio==0.12.1+cu113 \
    --index-url https://download.pytorch.org/whl/cu113

# 安装数据科学和测试所需包
RUN pip install --no-cache-dir \
    numpy==1.24.3 \
    pandas==2.0.3 \
    scikit-learn==1.3.0 \
    matplotlib==3.7.2 \
    seaborn==0.12.2 \
    tqdm==4.65.0 \
    pillow==10.0.0 \
    opencv-python-headless==4.8.0.74

# 安装性能监控和追踪工具
RUN pip install --no-cache-dir \
    psutil==5.9.5 \
    gputil==1.4.0 \
    py-cpuinfo==9.0.0 \
    memory-profiler==0.60.0

# 安装测试和开发工具
RUN pip install --no-cache-dir \
    pytest==7.4.0 \
    pytest-cov==4.1.0 \
    black==23.7.0 \
    flake8==6.0.0

# 创建工作目录
WORKDIR /codedag_tests

# 创建结果目录
RUN mkdir -p /codedag_tests/test_results

# 设置环境变量
ENV PYTHONPATH=/codedag_tests:/workspace

# 默认入口点
ENTRYPOINT ["/bin/bash"]